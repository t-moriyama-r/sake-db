# Lefthook configuration for backend
# Lefthookはリポジトリルートで動作しますが、バックエンドファイルのみをチェックします
# Refer for explanation: https://github.com/evilmartians/lefthook/blob/master/docs/configuration.md

pre-commit:
  parallel: true
  commands:
    # Go構文チェック  
    go-fmt:
      tags: backend
      files: git diff --name-only --cached backend/
      glob: "*.go"
      run: |
        cd backend
        gofmt -l . | grep '.go$' && echo "✗ Go files are not formatted. Run 'cd backend && make fmt'" && exit 1 || echo "✓ Go formatting check passed"
    
    # Go静的解析
    go-lint:
      tags: backend
      files: git diff --name-only --cached backend/
      glob: "*.go"
      run: |
        cd backend
        if command -v golangci-lint &> /dev/null; then
          # --new-from-rev を使用して変更されたファイルのみをチェック
          golangci-lint run --new-from-rev=HEAD~1
        else
          echo "⚠ golangci-lint not installed. Skipping linting."
          echo "  Install with: cd backend && make install-tools"
        fi
    
    # Go vet
    go-vet:
      tags: backend
      files: git diff --name-only --cached backend/
      glob: "*.go"
      run: cd backend && go vet ./...
    
    # GraphQLスキーマ検証
    graphql-validate:
      tags: backend graphql
      files: git diff --name-only --cached backend/graph/schema/
      glob: "*.graphqls"
      run: |
        cd backend
        echo "Validating GraphQL schema..."
        go run github.com/99designs/gqlgen generate --config gqlgen.yml
        if [ $? -eq 0 ]; then
          echo "✓ GraphQL schema validation passed"
          # 注意: 生成されたファイルは手動でgit addする必要があります
          if git diff --quiet graph/generated/ graph/graphModel/; then
            echo "  No changes in generated files"
          else
            echo "  ⚠ Generated files have been updated. Please add them to your commit:"
            echo "    git add backend/graph/generated/ backend/graph/graphModel/"
          fi
        else
          echo "✗ GraphQL schema validation failed"
          exit 1
        fi




