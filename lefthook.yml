# Lefthook configuration for backend
# Lefthookはリポジトリルートで動作しますが、バックエンドファイルのみをチェックします
# Refer for explanation: https://github.com/evilmartians/lefthook/blob/master/docs/configuration.md

pre-commit:
  parallel: true
  commands:
    # Go構文チェック
    go-fmt:
      tags: backend
      glob: "backend/**/*.go"
      root: "backend/"
      run: |
        if ! gofmt -l {staged_files} | grep .; then
          echo "✓ Go formatting check passed"
        else
          echo "✗ Go files are not formatted. Run 'gofmt -w' on the files above."
          exit 1
        fi
    
    # Go静的解析
    go-lint:
      tags: backend
      glob: "backend/**/*.go"
      root: "backend/"
      run: |
        if command -v golangci-lint &> /dev/null; then
          # --new-from-rev を使用して変更されたファイルのみをチェック
          golangci-lint run --new-from-rev=HEAD~1
        else
          echo "⚠ golangci-lint not installed. Skipping linting."
          echo "  Install with: cd backend && make install-tools"
        fi
    
    # Go vet
    go-vet:
      tags: backend
      glob: "backend/**/*.go"
      root: "backend/"
      run: go vet {staged_files}
    
    # GraphQLスキーマ検証
    graphql-validate:
      tags: backend graphql
      glob: "backend/graph/schema/*.graphqls"
      root: "backend/"
      run: |
        echo "Validating GraphQL schema..."
        go run github.com/99designs/gqlgen generate --config gqlgen.yml
        if [ $? -eq 0 ]; then
          echo "✓ GraphQL schema validation passed"
          # 注意: 生成されたファイルは手動でgit addする必要があります
          if git diff --quiet graph/generated/ graph/graphModel/; then
            echo "  No changes in generated files"
          else
            echo "  ⚠ Generated files have been updated. Please add them to your commit:"
            echo "    git add backend/graph/generated/ backend/graph/graphModel/"
          fi
        else
          echo "✗ GraphQL schema validation failed"
          exit 1
        fi

