# Lefthook configuration for sake-db project
# Refer for explanation: https://github.com/evilmartians/lefthook/blob/master/docs/configuration.md

pre-commit:
  parallel: true
  commands:
    # フロントエンド: ESLint
    frontend-lint:
      tags: frontend
      glob: "front/**/*.{js,ts,vue}"
      run: cd front && npx eslint {staged_files}
    
    # バックエンド: Go構文チェック
    go-fmt:
      tags: backend
      glob: "**/*.go"
      root: "backend/"
      run: |
        if ! gofmt -l {staged_files} | grep .; then
          echo "✓ Go formatting check passed"
        else
          echo "✗ Go files are not formatted. Run 'gofmt -w' on the files above."
          exit 1
        fi
    
    # バックエンド: Go静的解析
    go-lint:
      tags: backend
      glob: "**/*.go"
      root: "backend/"
      run: |
        if command -v golangci-lint &> /dev/null; then
          # --new-from-rev を使用して変更されたファイルのみをチェック
          golangci-lint run --new-from-rev=HEAD~1
        else
          echo "⚠ golangci-lint not installed. Skipping linting."
          echo "  Install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
        fi
    
    # バックエンド: Go vet
    go-vet:
      tags: backend
      glob: "**/*.go"
      root: "backend/"
      run: go vet {staged_files}
    
    # バックエンド: GraphQLスキーマ検証
    graphql-validate:
      tags: backend graphql
      glob: "backend/graph/schema/*.graphqls"
      run: |
        cd backend
        echo "Validating GraphQL schema..."
        go run github.com/99designs/gqlgen generate --config gqlgen.yml
        if [ $? -eq 0 ]; then
          echo "✓ GraphQL schema validation passed"
          # 注意: 生成されたファイルは手動でgit addする必要があります
          if git diff --quiet graph/generated/ graph/graphModel/; then
            echo "  No changes in generated files"
          else
            echo "  ⚠ Generated files have been updated. Please add them to your commit:"
            echo "    git add backend/graph/generated/ backend/graph/graphModel/"
          fi
        else
          echo "✗ GraphQL schema validation failed"
          exit 1
        fi


